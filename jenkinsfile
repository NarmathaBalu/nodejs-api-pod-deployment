pipeline {
    agent any

    environment {
        POD_NAME = "api-pod"
        API_IMAGE = "nodejs-api:latest"
        API_CONTAINER = "nodejs-api"
        REDIS_CONTAINER = "redis"
        API_PORT = 3000
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/NarmathaBalu/nodejs-api-pod-deployment.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '/usr/local/bin/npm install'
            }
        }

        stage('Build Node.js API Container') {
            steps {
                sh '/opt/homebrew/bin/podman build -t ${API_IMAGE} .'
            }
        }

        stage('Clean Previous Containers and Pod') {
            steps {
                sh '''
                # Remove previous pod if exists
                /opt/homebrew/bin/podman pod rm -f ${POD_NAME} || true

                # Remove any leftover containers
                /opt/homebrew/bin/podman rm -f ${API_CONTAINER} || true
                /opt/homebrew/bin/podman rm -f ${REDIS_CONTAINER} || true
                '''
            }
        }

        stage('Create Pod') {
            steps {
                sh '/opt/homebrew/bin/podman pod create --name ${POD_NAME} -p ${API_PORT}:${API_PORT}'
            }
        }

        stage('Run Containers in Pod') {
            steps {
                sh '''
                # Run Node.js API in pod
                /opt/homebrew/bin/podman run -d --pod ${POD_NAME} --name ${API_CONTAINER} ${API_IMAGE}

                # Run Redis container in the same pod
                /opt/homebrew/bin/podman run -d --pod ${POD_NAME} --name ${REDIS_CONTAINER} redis:alpine
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                # Retry curl to ensure API is up
                curl --retry 5 --retry-delay 2 http://localhost:${API_PORT}/health
                curl http://localhost:${API_PORT}/api/hello
                curl http://localhost:${API_PORT}/api/goodbye
                '''
            }
        }
    }

    post {
        always {
            sh '''
            # Clean up pod and containers after build
            /opt/homebrew/bin/podman pod rm -f ${POD_NAME} || true
            /opt/homebrew/bin/podman rm -f ${API_CONTAINER} || true
            /opt/homebrew/bin/podman rm -f ${REDIS_CONTAINER} || true
            '''
        }
    }
}
